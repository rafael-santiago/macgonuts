/*
 * Copyright (c) 2022, Rafael Santiago
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree.
 */
#include "macgonuts_iplist_tests.h"
#include <macgonuts_iplist.h>

CUTE_TEST_CASE(macgonuts_iplist_tests)
    macgonuts_iplist_handle *iplist = NULL;
    const char *iplist_data = "192.30.70.2,192.30.70.0/24,dead::beef,2001::50/64";
    struct test_ctx {
        uint8_t in_addr[16];
        size_t in_addr_size;
        int expected;
    } test_vector[] = {
        { { 0x7F, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, 4, 0 },
        { { 0xC0, 0x1E, 0x46, 0x02, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, 4, 1 },
        { { 0xC0, 0x1E, 0x46, 0x37, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, 4, 1 },
        { { 0xC0, 0x1E, 0x47, 0x37, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, 4, 0 },
        { { 0xDE, 0xAD, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xBE, 0xEF }, 16, 1 },
        { { 0x20, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x10, 0x01, 0x02, 0x03, 0x04, 0xAF, 0x00, 0x50 }, 16, 1 },
        { { 0x20, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
            0x10, 0x01, 0x02, 0x03, 0x04, 0xAF, 0x00, 0x50 }, 16, 0 },
    }, *test = &test_vector[0], *test_end = test + sizeof(test_vector) / sizeof(test_vector[0]);
    CUTE_ASSERT(macgonuts_iplist_parse(NULL, strlen(iplist_data)) == NULL);
    CUTE_ASSERT(macgonuts_iplist_parse(iplist_data, 0) == NULL);
    iplist = macgonuts_iplist_parse(iplist_data, strlen(iplist_data));
    CUTE_ASSERT(iplist != NULL);
    while (test != test_end) {
        CUTE_ASSERT(macgonuts_iplist_has(iplist, test->in_addr, test->in_addr_size) == test->expected);
        test++;
    }
    macgonuts_iplist_release(iplist);
CUTE_TEST_CASE_END
